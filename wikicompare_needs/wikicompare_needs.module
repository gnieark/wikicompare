<?php


require_once drupal_get_path('module', 'wikicompare') . '/wikicompare_comparative_table.inc';

/**
 * Implements hook_node_info().
 * This function create the new node type we need for the module
 */
function wikicompare_needs_node_info() {
  return array(
    'need' => array(
      'name' => t('Need'),
      'base' => 'need',
      'description' => t('TODO : Need description'),
      'help' => t('TODO : Need submission guidelines'),
      'title_label' => t('Title'),
    ),

  );
}


/**
 * Implements hook_form().
 * We need it to display the title in the node form
 */
function need_form($node, $form_state) {
  return node_content_form($node, $form_state);
}



/*
function wikicompare_needs_wikicompare_install_node_install($type) {

  if ($type == 'need') {



    $instance = array(
      'field_name' => 'need_state',
      'entity_type' => 'node',
      'bundle' => 'need',
      'label' => 'State',
      'description' => 'TODO : State of the need',
      'required' => 1,
      'default_value' => array(
        0 => array(
          'value' => 'Disactivated',
        ),
      ),
      'widget' => array(
        'type' => 'options_select',
      ),
    );
    field_create_instance($instance);

  }

}
*/

function wikicompare_needs_form_need_node_form_alter(&$form, &$form_state, $form_id) {

  wikicompare_build_form($form, $form_state);

  $selected_feature_ids = array();
  if (isset($form_state['node']->wikicompare_features['und'])) {
    foreach ($form_state['node']->wikicompare_features['und'] as $array) {
      $id = $array['target_id'];
      $selected_feature_ids[$id] = $id;
    }
  }

  //hide($form['need_features']);
  $selected_feature_itemlist = '';
  $feature_array = array();
  if ($selected_feature_ids) {
    $feature_array = get_recursive_data('feature', $selected_feature_ids);
  

    $itemlist_settings = initialize_itemlist_settings('feature_list_computed');
    //Building the data for the item list
    $item_list_data = get_item_list($feature_array['tree'], 'feature', 'feature_list_computed', 0, $itemlist_settings);
    //Render the item list
    $selected_feature_itemlist = theme_item_list(array('items' => $item_list_data, 'title' => 'Manually selected features', 'type' => 'ul', 'attributes' => array()));
  }


  $select_feature_link = array(
    'text' => 'Select features',
    'title' => 'Select features',
    'selector' => 'dialog-content',
    'path' => 'get_dialog_callback/select_multi_dialog/feature/form_selected_features/0',
    'id' => 'select_feature_link',

  );
  
  $form['container_selected_feature'] = array(
    'itemlist' => array('#markup' => $selected_feature_itemlist),
    '#type' => 'container',
    '#id' => 'form_selected_features',
    '#weight' => -2,
    '#suffix' => '<p>' . theme('simple_dialog_link', $select_feature_link) . '</p>'
  
  );

}



function wikicompare_needs_build_form_settings(&$settings, &$node, &$nid, $form, $form_state) {


  if ($form_state['node']->type == 'need') {
      $selected_feature_ids = array();
      if (isset($form_state['node']->wikicompare_features['und'])) {
        foreach ($form_state['node']->wikicompare_features['und'] as $array) {
          $id = $array['target_id'];
          $selected_feature_ids[$id] = $id;
        }
      }

      $settings['wikicompare_needs']['selected_feature_ids'] = $selected_feature_ids;

  }

}


function wikicompare_needs_wikicompare_comparative_table_before_compute(&$output) {

  $needs = array();

  $query = db_select('cache_need', 'n');
  $query->addField('n', 'nid', 'nid');
  $query->addField('n', 'title', 'title');
  $query->addField('n', 'has_children', 'has_children');
  $query->addField('n', 'parent_id', 'parent_id');
  $query->condition('n.parent_id', NULL);
  $result = $query->execute();

  $needs = request_db('need');

  $itemlist_settings = initialize_itemlist_settings('select_multi_dialog');

  $item_list_data = get_item_list($needs, 'need', 'select_multi_dialog', 0, $itemlist_settings);

  $output .= theme_item_list(array('items' => $item_list_data, 'title' => '',  'type' => 'ul', 'attributes' => array()));

}

function wikicompare_needs_wikicompare_comparative_table_prepare_itemlist($key, &$nodes, $_POST) {

  if (!empty($_POST['selected_need_ids'])) {

    $selected_need_ids = array();
    foreach ($_POST['selected_need_ids'] as $selected_need_id) {
      $selected_need_ids[$selected_need_id[0]] = $selected_need_id[0];
    }

    if (in_array($key, $selected_need_ids)) {
      $nodes[$key]['data']->displayed = True;
    }

  }

}

function wikicompare_needs_wikicompare_comparative_table_prepare_compute(&$selected_feature_ids, $_POST) {

  if (!empty($_POST['selected_need_ids'])) {

    $feature_ids = recover_features($_POST['selected_need_ids']);
    foreach ($feature_ids as $feature_id) {
      $selected_feature_ids[$feature_id] = $feature_id;
    }

  }

}

/*
function wikicompare_needs_wikicompare_comparative_table_toogle_fastedit(&$commands, $_POST) {

  $needs = array();
  if (!empty($_POST['need_ids'])) {
    $needs = request_db('need', array('fastedit_status' => 1), 'nids', $_POST['need_ids']);
  }

  foreach($needs as $nid =>$need) {
    $output = add_fastedit_items('need', $need);
    //Insert the link in the page. Note we can't use ajax_command_after because it adds an unwanted div
    $commands[] = ajax_command_invoke('#need_node_link_' . $nid, 'after', array($output));
  }

}
*/

function wikicompare_needs_wikicompare_comparative_table_fastedit_parent(&$parent_id, $type, $node) {

  if ($type == 'need') {
    $parent_id = $node->wikicompare_parent_id['und'][0]['target_id'];
  }

}

function wikicompare_needs_wikicompare_comparative_table_fastedit_specific(&$output, $type, $node, $fastaction, $nid) {

  if ($type == 'need') {


    $selected_feature_itemlist = '';
    $selected_feature_hidden = '';
    if ($fastaction == 'edit') {
      $selected_feature_ids = array();
      if (isset($node->wikicompare_features['und'])) {
        foreach ($node->wikicompare_features['und'] as $array) {
          $id = $array['target_id'];
          $selected_feature_ids[] = $id;
        }
      }

      
      $feature_array = array();
      if ($selected_feature_ids) {
        $feature_array = get_recursive_data('feature', $selected_feature_ids);
  
        $itemlist_settings = initialize_itemlist_settings('feature_list_computed');
        //Building the data for the item list
        $item_list_data = get_item_list($feature_array['tree'], 'feature', 'feature_list_computed', 0, $itemlist_settings);
        //Render the item list
        $selected_feature_itemlist = theme_item_list(array('items' => $item_list_data, 'title' => 'Manually selected features', 'type' => 'ul', 'attributes' => array()));

        
        foreach ($selected_feature_ids as $feature_id) {
          $selected_feature_hidden .= '<div class="need_feature">' . $feature_id . '</div>';
        }
        

      }

      

    }


    $select_feature_link = array(
      'text' => 'Select features',
      'title' => 'Select features',
      'selector' => 'dialog-content',
      'path' => 'get_dialog_callback/select_multi_dialog/feature/form_selected_features/0',
      'id' => 'select_feature_link',
    );
    $output .= '<div id="form_selected_features">';
    $output .= $selected_feature_itemlist;
    $output .= '</div><div id="need-features">' . $selected_feature_hidden . '</div><p>' . theme('simple_dialog_link', $select_feature_link) . '</p>';

    $state_field = array(
      '#type' => 'select',
      '#title' => t('State'),
      '#options' => array(
        'New' => 'New',
        'Incomplete' => 'Incomplete',
        'Published' => 'Published',
        'Disactivated' => 'Disactivated',
      ),
      '#id' => 'form_' . $type . '_fast' . $fastaction . '_state_' . $nid,
        '#attributes' => array(
        'class' => array('form_' . $type . '_fast' . $fastaction . '_state'),
      )
    );
    if ($fastaction == 'edit') {
      $state_field['#value'] = $node->wikicompare_state['und'][0]['value'];
    }
    $output .= drupal_render($state_field);

/*TODO    $support_field = array(
      '#type' => 'select',
      '#title' => t('Support'),
      '#options' => array(
        0 => 'Unsupported',
        1 => 'Supported',
      ),
      '#id' => 'form_' . $type . '_fast' . $fastaction . '_support_' . $nid,
      '#attributes' => array(
        'class' => array('form_' . $type . '_fast' . $fastaction . '_support'),
      )
    );
    if ($fastaction == 'edit') {
      $support_field['#value'] = $node->feature_support['und'][0]['value'];
    }
    $output .= drupal_render($support_field);*/
  }

}

function wikicompare_needs_wikicompare_comparative_table_fastedit_command(&$commands, $type, $nid, $output) {


  if ($type == 'need') {
    $commands[] = ajax_command_invoke('#need_children_' . $nid, 'before', array($output));
  }

}


function wikicompare_needs_wikicompare_comparative_table_fastedit_submit(&$node, $type, $_POST) {



  if ($type == 'need') {

    $need_features = array();
    foreach ($_POST['need_feature_ids'] as $feature_id) {
      $array = array();
      $array['target_id'] = $feature_id;
      $array['target_type'] = "node";
      $need_features[] = $array;
    }
    $node->wikicompare_features[$node->language] = $need_features;
    $node->wikicompare_parent_id[$node->language][0]['target_id'] = $_POST['parent_id'];
    $node->wikicompare_parent_id[$node->language][0]['target_type'] = "node";
    $node->wikicompare_state[$node->language][0]['value'] = $_POST['state'];

  }

}

function wikicompare_needs_wikicompare_comparative_table_cleaning(&$commands, $_POST) {


  $need_ids = array();
  foreach ($_POST['need_ids'] as $need) {
    $need_ids[$need[0]] = $need[0];
  }
  $needs = array();
  if (!empty($need_ids)) {
    $needs = request_db('need', array(), 'nids', $need_ids);
  }
    
  foreach ($_POST['need_ids'] as $need) {
    if ($need[1] != $needs[$need[0]]['data']->parent_id) {
      if (in_array($need[1], $_POST['need_displayed_ids'])) {
        $commands[] = ajax_command_invoke('#need_link_' . $need[1], 'click', array());
      }
      if (in_array($needs[$need[0]]['data']->parent_id, $_POST['need_displayed_ids'])) {
        $commands[] = ajax_command_invoke('#need_link_' . $needs[$need[0]]['data']->parent_id, 'click', array());
      }
    }
  }

  foreach($needs as $nid => $need) {
    $commands[] = ajax_command_invoke('.need_title_' . $nid, 'html', array($need['data']->title));
  }

}

function recover_features($need_ids) {

  $feature_ids = array();

  $query = db_select('cache_need', 'n');
  $query->addField('n', 'nid', 'nid');
  $query->addField('n', 'parent_id', 'parent_id');
  $query->addField('f', 'feature_nid', 'feature_id');
  $query->leftjoin('cache_need_feature_rel', 'f', 'n.nid = f.need_nid');
  $query->condition('n.nid', $need_ids, 'in');
  $result = $query->execute();  

  $need_parent_ids = array();
  foreach ($result as $record) {
    $feature_ids[$record->feature_id] = $record->feature_id;
    $need_parent_ids[$record->parent_id] = $record->parent_id;
  }
//TODO Block if parent is disactivated
  if (!empty($need_parent_ids)) {
    $feature_from_parent_ids = recover_features($need_parent_ids);
    foreach ($feature_from_parent_ids as $feature_id) {
      $feature_ids[$feature_id] = $feature_id;
    }
  }

  return $feature_ids;

}



function need_insert($node) {



  if ($node->language != language_default('language')) {
    return;
  }

  wikicompare_insert_node('need', $node);

//dpm($node);
  $feature_m2m = array();
  foreach ($node->wikicompare_features['und'] as $feature) {

    $feature_m2m[] = array(
      'need_nid' => $node->nid,
      'feature_nid' => $feature['target_id'],
    );
  }

  $header = array('need_nid', 'feature_nid');

  //Update the cache_implementation table before the compare tree computation
  if (!empty($feature_m2m)) {
    $query = db_insert('cache_need_feature_rel')->fields($header);
    foreach ($feature_m2m as $record) {
      $query->values($record);
    }
    $query->execute();
  }

//TODO update many2many table
}

function need_delete($node) {

  wikicompare_delete_node('need', $node);


  db_delete('cache_need_feature_rel')
    ->condition('need_nid', $node->nid)
    ->execute();

}


function wikicompare_needs_wikicompare_node_types(&$array) {

  $array[] = 'need';

}

function wikicompare_needs_wikicompare_cache_update_fields(&$fields, $node_revision) {

  if ($node_revision->type == 'need') {
    $fields['state'] = $node_revision->need_state['und'][0]['value'];
  }

}

function wikicompare_needs_wikicompare_cache_after_update_fields(&$fields, $node_revision) {

  if ($node_revision->type == 'need') {

    $query = db_select('cache_need_feature_rel', 'f');
    $query->addField('f', 'feature_nid', 'feature_nid');
    $query->condition('f.need_nid', $node_revision->nid);
    $result = $query->execute();

    $new_feature_ids = array();
    if (isset($node_revision->wikicompare_features['und'])) {
      foreach ($node_revision->wikicompare_features['und'] as $feature) {
        $new_feature_ids[$feature['target_id']] = $feature['target_id'];
      }
    }

    $old_feature_ids = array();
    $to_delete = array();
    foreach ($result as $record) {
      $old_feature_ids[$record->feature_nid] = $record->feature_nid;
      if (!in_array($record->feature_nid, $new_feature_ids)) {
        $to_delete[$record->feature_nid] = $record->feature_nid;
      }
    }

    $to_create = array();
    foreach ($new_feature_ids as $feature_id) {
      if (!in_array($feature_id, $old_feature_ids)) {
        $to_create[$feature_id] = array(
          'need_nid' => $node_revision->nid,
          'feature_nid' => $feature_id,
        );
      }
    }

    $header = array('need_nid', 'feature_nid');
    if (!empty($to_create)) {
      $query = db_insert('cache_need_feature_rel')->fields($header);
      foreach ($to_create as $record) {
        $query->values($record);
      }
      $query->execute();
    }

    if (!empty($to_delete)) {
      db_delete('cache_need_feature_rel')
        ->condition('need_nid', $node_revision->nid)
        ->condition('feature_nid', $to_delete, 'in')
        ->execute();
    }

  }

}

function wikicompare_needs_wikicompare_translation_form(&$form, &$form_state, $node) {

  if (isset($form['need_features'])) {
//    $form['need_features'] = array('#markup' => $node->wikicompare_support['und'][0]['value']);
    unset($form_state['node']->wikicompare_features);
  }

}


?>
